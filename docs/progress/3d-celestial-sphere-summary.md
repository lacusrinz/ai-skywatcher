# 3D天球视图实现总结

> **⚠️ 已被替代**: 此版本（v2.0.0）使用的是外部球体视角，已被后续版本持续优化。
>
> **版本演进**:
> - v2.1.0: [中心视角天球视图](./center-perspective-celestial-sphere-summary.md)
> - v2.2.0: [天空图优化与时间轴改进](./2025-01-23-sky-map-optimization-summary.md)
>
> **v2.0.0 问题**: 使用 `distance / (distance - z)` 公式，观测者实际位于球体外向内看，不符合真实天文观测体验。
> **v2.1.0 改进**: 使用 `perspective / (z + perspective)` 公式，观测者位于天球中心向外看，符合真实体验。

---

## 项目信息

**项目名称**: AI Skywatcher - 天文观测助手
**功能名称**: 3D天球视图与视角控制（外部视角版本）
**开发日期**: 2026-01-23
**版本**: 2.0.0（已废弃）
**状态**: ⚠️ 已被 v2.1.0 替代

---

## 功能概述

将原有的2D平面天空图升级为**3D天球视图**，实现了球面投影和交互式视角控制。用户可以拖动鼠标旋转视角，查看不同方位的星空，星系目标分布在3D球面上。

> **注意**: 此版本使用的是外部视角（从球体外向内看），类似观看地球仪的体验。虽然技术上实现了3D投影，但不符合真实的天文观测体验（人在地球上仰望星空）。

---

## 核心特性

### 1. 3D球面投影（外部视角） ⚠️

**技术实现**:
- 3D球面投影算法
- 透视投影（Perspective Projection）
- **观察者位于球体外**（不是中心）
- 只渲染可见的前半球

**问题**: 使用 `distance / (distance - z)` 公式，当 z 接近 distance 时目标会变得异常大，不符合真实透视体验。

**数学模型**:
```javascript
// 球面坐标转换
x = R * cos(alt) * sin(az - viewAz)
y = R * sin(alt)
z = R * cos(alt) * cos(az - viewAz)

// 应用观测者高度角倾斜
y' = y * cos(tilt) - z * sin(tilt)
z' = y * sin(tilt) + z * cos(tilt)

// 透视投影
projection = distance / (distance - z')
screenX = centerX + x * projection * zoom
screenY = centerY - y * projection * zoom
```

### 2. 交互式视角控制 ✅

**鼠标操作**:
- **拖动旋转**: 水平拖动改变方位角（0-360°）
- **垂直拖动**: 垂直拖动改变高度角（0-90°）
- **滚轮缩放**: 放大/缩小天球（0.5x - 3.0x）

**视角参数**:
```javascript
view: {
  azimuth: 0,      // 方位角（0=北, 90=东, 180=南, 270=西）
  altitude: 30,    // 高度角（0=地平线, 30=默认, 90=天顶）
  zoom: 1.0        // 缩放倍数
}
```

### 3. 球面目标分布 ✅

**实现要点**:
- 目标按照真实的球面坐标分布
- 近大远小的透视效果
- Z轴排序实现正确的遮挡关系
- 地平线以下的目标自动隐藏

**目标渲染**:
```javascript
// 按Z轴排序（远到近）
sortedTargets.sort((a, b) => posA.z - posB.z);

// 根据透视距离调整大小
baseSize = 6 * scale
size = baseSize * projection * zoom

// 只渲染可见目标
if (visible && altitude > 0) {
  drawTarget();
}
```

### 4. 3D网格系统 ✅

**高度角圈**: 30°, 60°, 90°
- 按照3D球面绘制
- 虚线样式
- 自动裁剪地平线以下部分

**方位角线**: 每45°一条
- 从天顶辐射到地平线
- 动态根据视角旋转
- 标注N/NE/E/SE/S/SW/W/NW

---

## 视觉效果

### 天球渲染

**球体效果**:
```
1. 天球轮廓（圆）
2. 球面网格（3层同心圆，营造深度感）
3. 地平线（绿色）
4. 高度角圈（3D投影）
5. 方位角线（辐射状）
```

**目标显示**:
- 颜色编码（5种天体类型）
- 透视缩放（近大远小）
- 悬停光晕效果
- 名称标签
- 详细信息（高度角、方位角）

### 视觉反馈

**鼠标状态**:
- 默认: `grab`（可抓取）
- 悬停目标: `pointer`（可点击）
- 拖动时: `grabbing`（抓取中）

**实时信息**:
- 右下角：当前视角（方位角 高度角）
- 左下角：操作提示（拖动旋转视角 | 滚轮缩放）

---

## 交互操作

### 旋转视角（改变观测方向）

```
水平拖动 → 改变方位角
┌─────────────────────────────────┐
│  拖动距离 Δx                    │
│  方位角变化 Δaz = Δx × 0.5°     │
│  范围: 0-360°                   │
│                                 │
│  向右拖动 → 顺时针旋转           │
│  向左拖动 → 逆时针旋转           │
└─────────────────────────────────┘

示例：
0°   → 面向北
90°  → 面向东
180° → 面向南
270° → 面向西
```

### 调整高度角（改变观测仰角）

```
垂直拖动 → 改变高度角
┌─────────────────────────────────┐
│  拖动距离 Δy                    │
│  高度角变化 Δalt = -Δy × 0.3°   │
│  范围: 0-90°                    │
│                                 │
│  向上拖动 → 提高视角            │
│  向下拖动 → 降低视角            │
└─────────────────────────────────┘

示例：
0°   → 看地平线
30°  → 默认视角
60°  → 看天顶
90°  → 看正上方
```

### 缩放天球

```
滚轮操作 → 缩放天球
┌─────────────────────────────────┐
│  向上滚动 → 放大（最大3.0x）      │
│  向下滚动 → 缩小（最小0.5x）      │
└─────────────────────────────────┘
```

---

## 用户使用场景

### 场景 1: 观测东方升起的猎户座

```
1. 打开应用，默认视角：北、高度角30°
   → 看到北方的星空

2. 向右拖动鼠标（约90°）
   → 视角转向东方
   → 看到猎户座从地平线升起

3. 向上拖动鼠标
   → 提高视角
   → 更清楚地看到猎户座大星云

4. 滚轮放大
   → 猎户座目标变大
   → 便于查看细节
```

### 场景 2: 查看整个天球

```
1. 转向北方（方位角0°）
   → 查看北半球星空

2. 降低视角到地平线（高度角0°）
   → 看到地平线上的星座

3. 慢慢顺时针旋转拖动
   → 扫描整个天空
   → 寻找最佳拍摄目标
```

### 场景 3: 规划多目标拍摄

```
1. 转向M42方向
   → 查看M42在天空中的位置

2. 记录M42的方位角和高度角
   → 确认拍摄角度

3. 转向M31方向
   → 查看M31位置

4. 确定观测顺序
   → 根据高度角安排拍摄时间
```

---

## 技术实现细节

### 3D投影算法

```javascript
projectTo3D(azimuth, altitude) {
  // 1. 转换为弧度
  const az = azimuth * (π / 180);
  const alt = altitude * (π / 180);

  // 2. 获取当前视角
  const viewAz = this.view.azimuth * (π / 180);
  const viewAlt = this.view.altitude * (π / 180);

  // 3. 球面坐标转换
  x = R × cos(alt) × sin(az - viewAz)
  y = R × sin(alt)
  z = R × cos(alt) × cos(az - viewAz)

  // 4. 应用高度角倾斜
  y' = y × cos(viewAlt) - z × sin(viewAlt)
  z' = y × sin(viewAlt) + z × cos(viewAlt)

  // 5. 透视投影
  distance = 2R
  projection = distance / (distance - z')
  screenX = centerX + x × projection × zoom
  screenY = centerY - y × projection × zoom

  // 6. 可见性判断
  visible = z > -0.2R && altitude > 0

  return { x, y, z, visible, scale: projection };
}
```

### 坐标系统

**地平坐标系（Horizontal System）**:
- 方位角（Azimuth）: 从正北顺时针测量，0-360°
- 高度角（Altitude）: 从地平线向上测量，0-90°

**赤道坐标系（Equatorial System）**:
- 赤经（Right Ascension）: 春分点向东，0-360°
- 赤纬（Declination）: 天球赤道向北/南，-90°到+90°

**转换关系**:
```javascript
// 赤道坐标 → 地平坐标
Ha = LST - RA  // 时角
sin(Alt) = sin(Dec)×sin(Lat) + cos(Dec)×cos(Lat)×cos(Ha)
cos(Az) = (sin(Dec) - sin(Alt)×sin(Lat)) / (cos(Alt)×cos(Lat))
```

### 性能优化

**Z轴排序**:
```javascript
// 远的目标先绘制，近的后绘制
sortedTargets.sort((a, b) => {
  const posA = projectTo3D(a.azimuth, a.altitude);
  const posB = projectTo3D(b.azimuth, b.altitude);
  return posA.z - posB.z;
});
```

**可见性裁剪**:
- 只渲染 z > -0.2R 的目标（前半球）
- 只渲染高度角 > 0 的目标（地平线以上）

**透视投影**:
- 近大远小的效果
- 使用距离缩放因子

---

## Canvas绘制流程

```
1. clearRect()               清空画布
   ↓
2. drawBackground()         深空渐变背景
   ↓
3. drawCelestialSphere()    天球轮廓和网格效果
   ↓
4. drawGrid()               3D高度角圈和方位角线
   ↓
5. drawHorizon()            地平线（绿色）
   ↓
6. drawTargets()            目标（按Z轴排序）
   ↓
7. drawCompass()            视角信息和操作提示
```

---

## 与2D版本对比

### 2D平面视图（v1.x）

**优点**:
- 简单直观
- 易于理解
- 性能开销小

**缺点**:
- 不真实（平面投影）
- 无法体现球面分布
- 视角固定

### 3D天球视图（v2.0）

**优点**:
- ✅ 真实的球面投影
- � 目标正确分布在球面上
- ✅ 可交互式视角控制
- ✅ 透视效果（近大远小）
- ✅ 沉浸式体验

**缺点**:
- 计算开销略大
- 需要一定的学习成本

---

## 代码架构

### 新增方法

```javascript
// 3D投影核心
projectTo3D(azimuth, altitude)

// 赤道坐标转地平坐标
raDecToAzAlt(ra, dec, lst, lat)

// 视角控制
setView(azimuth, altitude)
resetView()

// 渲染方法
drawCelestialSphere()  // 天球轮廓
drawGrid()             // 3D网格
drawHorizon()          // 地平线
drawCompass()         // 指南针
```

### 新增状态

```javascript
view: {
  azimuth: 0,      // 观测方位角
  altitude: 30,    // 观测高度角
  zoom: 1.0        // 缩放倍数
}

state: {
  isDragging: false,    // 是否拖动中
  lastMouseX: 0,       // 上次鼠标X
  lastMouseY: 0        // 上次鼠标Y
}
```

---

## 使用示例

### 编程方式控制视角

```javascript
// 设置视角为东方，高度45°
skyMap.setView(90, 45);

// 重置为默认视角
skyMap.resetView();
```

### 事件监听

```javascript
// 目标选择回调
skyMap.onTargetSelect = (targetId) => {
  console.log('Selected:', targetId);
  // 滚动到推荐列表中的目标卡片
};
```

---

## 数学原理

### 球面坐标到笛卡尔坐标

```
给定：方位角 az，高度角 alt
球面坐标 (θ, φ)：
  θ = 90° - alt  （极角，从天顶向下）
  φ = az          （方位角）

笛卡尔坐标：
  x = R × sin(θ) × cos(φ)
  y = R × cos(θ)
  z = R × sin(θ) × sin(φ)

其中：
  R 是天球半径
  高度角 alt = 90° - θ
```

### 旋转变换

```javascript
// 绕Y轴旋转（方位角）
x' = x × cos(viewAz) - z × sin(viewAz)
z' = x × sin(viewAz) + z × cos(viewAz)

// 绕X轴旋转（高度角）
y'' = y' × cos(viewAlt) - z' × sin(viewAlt)
z'' = y' × sin(viewAlt) + z' × cos(viewAlt)
```

### 透视投影

```javascript
透视投影公式：
  screenX = centerX + x × (d / (d - z))
  screenY = centerY - y × (d / (d - z))

其中：
  d 是观察者距离（通常取 2R）
  z 是深度坐标
```

---

## 测试结果

### 构建测试
```bash
✅ Frontend build successful (71ms)
✅ CSS: 13.86 kB (gzip: 2.96 kB)
✅ JS: 24.21 kB (gzip: 7.97 kB)
✅ No syntax errors
```

### 功能测试

| 功能 | 测试场景 | 结果 |
|------|---------|------|
| **3D渲染** | 启动应用 | ✅ 天球正确渲染 |
| **水平旋转** | 水平拖动 | ✅ 方位角平滑变化 |
| **垂直旋转** | 垂直拖动 | ✅ 高度角平滑变化 |
| **缩放** | 滚轮操作 | ✅ 天球缩放正常 |
| **目标分布** | 观察球面 | ✅ 目标在球面上 |
| **透视效果** | 近大远小 | ✅ 正确的透视 |
| **遮挡关系** | Z轴排序 | ✅ 正确的遮挡 |
| **地平线过滤** | 低高度目标 | ✅ 自动隐藏 |
| **悬停效果** | 鼠标悬停 | ✅ 显示详细信息 |
| **视角信息** | 右下角显示 | ✅ 实时更新 |

---

## 交互指南

### 快速入门

**第一次使用**:
1. 打开应用，看到默认视角（北、高度角30°）
2. 向右拖动鼠标约90°，转向东方
3. 看到东方升起的星座
4. 向上拖动鼠标，提高视角
5. 滚轮放大，查看目标细节

**最佳观测角度**:
- **扫描天空**: 高度角30°，旋转360°
- **观测地平线**: 高度角0°，扫描目标方位
- **观测天顶**: 高度角90°，查看头顶目标

---

## 后续优化建议

### 短期（可选）
- [ ] 添加视角平滑过渡动画
- [ ] 支持键盘快捷键控制视角
- [ ] 添加视角预设按钮（北/东/南/西/天顶）
- [ ] 显示星座连线

### 中期（可选）
- [ ] 实现自动旋转演示模式
- [ ] 添加星等和银河带
- [ ] 支持自定义时间流逝动画
- [ ] 添加星座名称标注

### 长期（可选）
- [ ] 使用WebGL提升渲染性能
- [ ] 添加更多天体（恒星、行星）
- [ ] 实现360°全景视图
- [ ] 支持VR设备查看

---

## 已知限制

1. **性能**: 大量目标时可能影响性能（可考虑WebGL）
2. **精度**: Canvas 2D渲染，精度不如专业天文软件
3. **时间**: 实时更新目标位置需要调用API
4. **学习**: 需要一定的天文知识才能有效使用

---

## 总结

### 实现成果
- ✅ 完整的3D天球投影
- ✅ 交互式视角控制
- ✅ 真实的球面目标分布
- ✅ 透视投影效果
- ✅ 流畅的用户体验
- ✅ 构建测试通过

### 技术突破
- ✅ 从2D平面升级到3D球面
- ✅ 实现真正的球面投影算法
- ✅ 支持全方位视角控制
- ✅ 保持良好的性能

### 用户体验
- ✅ 沉浸式3D体验
- ✅ 直观的拖拽操作
- ✅ 实时的视觉反馈
- ✅ 清晰的操作提示

### 开发质量
- ✅ 代码结构清晰
- ✅ 数学模型准确
- ✅ 注释完整详细
- ✅ 易于维护扩展

---

**开发完成日期**: 2026-01-23
**版本**: 2.0.0
**状态**: ✅ 生产就绪
**测试状态**: ✅ 全部通过
